{"./":{"url":"./","title":"Introduction","keywords":"","body":"SMAGV-Autoware連携手順書 Rev. 作成日 R0.00 2019/08/23 来歴 Rev. 作成日 変更内容 R0.00 2019/08/23 新規作成 "},"src/md/chpt0000.html":{"url":"src/md/chpt0000.html","title":"はじめに","keywords":"","body":"はじめに 本書は、Synergic Mobility 無人搬送車（以下SMAGV）とAutowareを連携するための手順書である。 "},"src/md/chpt0100.html":{"url":"src/md/chpt0100.html","title":"概要","keywords":"","body":"概要 本書は、SMAGVとAutowareを連携するための以下の手順について説明する。 環境変数の設定 システムの起動 ROSBAGの取得 点群地図の作成 AGVの自己位置推定 経路設定ファイル作成 経路の自動走行 "},"src/md/chpt0200.html":{"url":"src/md/chpt0200.html","title":"前提条件","keywords":"","body":"前提条件 前提条件を以下に示す。 必要な機器 必要なモジュールを以下に示す。 # 内容 条件 備考 1 SMAGV本体 必須 2 SMAGV制御用PC 必須 ubuntu 16.04以降 ※GPU搭載のものが望ましい 3 Velodyne 3D Lider 必須 本書ではセットアップ方法等については省略 必要なソフトウェア 必要なモジュールを以下に示す。 # 内容 条件 備考 1 SMAGV制御プログラム 必須 V3以降 2 ROS 必須 kinetic以降 3 Autoware 必須 1.10.0以降 ※未インストールの場合、事前にインストールをしておくこと。 ※本書では、Autowareに関する説明の部分でバージョン1.10.0、1.11.1が混在している場合がる。 "},"src/md/chpt0300.html":{"url":"src/md/chpt0300.html","title":"環境変数の設定","keywords":"","body":"環境変数の設定 Autoware連携に先立ち、事前に環境変数を設定する。 設定済み確認 ターミナルで以下のコマンドを実行し、環境変数設定がされていることを確認する。 $ rospack list 結果に「autoware_xxx」があればOK。 環境変数の設定 $HOME/.bashrc ファイルを開き、以下のコマンドを追記する。 source ~/Autoware/ros/devel/setup.bash ← 1.10.0 の場合 source ~/Autoware/ros/install/setup.bash ← 1.11.0 以降の場合 【追記例】 $ gedit ~/.bashrc ← エディタ起動 編集後、保存してエディタを閉じる。その後、ターミナルから以下のコマンドを実行、またはPC再起動し、環境変数の取込みを行う。 $ source ~/.bashrc 処理終了後、前項に従い、設定済み確認を行う。 その他 特になし "},"src/md/chpt0400.html":{"url":"src/md/chpt0400.html","title":"システムの起動","keywords":"","body":"システムの起動 システムの起動方法を以下に示す。 Velodyneの起動 本書では、簡易的に説明する。詳細については、Velodyneマニュアル参照の事。 Velodyneと制御用PCをLANケーブルで接続し、電源を投入する。 回線未接続状態であることを確認する。（上図） ターミナルで以下のコマンドを実行し、IPアドレス設定を行う。 # enp3s0f1 : eth名（PCによって異なるので適宜調整する） $ sudo ifconfig enp3s0f1 192.168.1.100 ← PC側IP Addr.設定 $ sudo route add 192.168.1.201 enp3s0f1 ← Velodneへのルート設定 SMAGVの起動 ターミナルで以下のコマンドを実行し、launchファイルを実行する。 $ roslaunch smagv_common VLPtest.launch ← 仮ファイル Autowareの起動 ターミナルで以下のコマンドを実行し、Autowareを実行する。 $ cd ~/Autoware/ros/ $ ./run その他 特になし "},"src/md/chpt0500.html":{"url":"src/md/chpt0500.html","title":"ROSBAGの取得","keywords":"","body":"ROSBAGの取得 ROSBAGファイル作成方法を種類ごとに以下に示す。 ターミナルコマンドによる取得 ターミナルコマンド指示による、ROSBAG取得方法の例を以下に示す。 ターミナルから「rosbag record」コマンドを実行し、ROSBAG取得を行う。 $ rosbag record -a # 全トピック $ rosbag record -a --split --duration=5m # 全トピック 5分毎分割 ※詳細は 「rosbag record --help」 参照 Ctrl+Cで終了 Autoware Runtime Managerによる取得 Autoware Runtime Managerによる、ROSBAG取得方法の例を以下に示す。 Autoware Runtime Managerウィンドウの［ROSBAG］ボタンを押下し、［ROSBAG Record］ウィンドウを表示する。 ファイル名、分割サイズ、取得トピックを適宜設定し［Start］ボタンを押下する。 ［Stop］ボタン押下で停止する。 "},"src/md/chpt0600.html":{"url":"src/md/chpt0600.html","title":"点群地図の作成","keywords":"","body":"点群地図（NDT MAP、PCD）の作成 Autowareによる点群地図作成方法（作成済のROSBAGからの生成）を以下に示す。 作業前の情報を初期化するため、Autowareを再起動する。 ROSBAG再生＆一時停止 ROSの時間をPCの時刻から、ROSBAG時刻に同期させるため、ROSBAG再生＆一時停止を行う。 Runtime Managerの［Simulation］タブを選択。 ［Ref］ボタン押下でROSBAGファイルを選択する。 ［Play］ボタン押下でROSBAGファイルを再生する。 再生後すぐに［Pause］ボタン押下でROSBAGファイル再生を一時停止する。 Baselink to Localizerの設定（任意） base_linkから見た、lider（points_raw）のTFを設定する。 点群地図作成時には必須ではないが、NDTマッチングが正常動作しないことある。ただし、NDTマッチングの際に本項目を設定することで対応が可能なため適宜設定する。 Runtime Managerの［Setup］タブを選択。 TF情報を入力する。 ［TF］ボタン押下で確定する。 押下後、ボタン色反転することを確認する。 TF情報参考値 # 機種 tf_x tf_z 1 SMAGV 0.255 0.836 2 LogieeS-TC 0.74 0.32 Vihicle Modelの設定（任意） RVizに表示するVihicle Modelを設定する。（表示が必要な場合のみ） Runtime Managerの［Setup］タブを選択。 Vehicle Modelグループ［Ref］ボタン押下でロボットモデルファイルを選択する。 Vehicle Modelグループ［Vehicle Model］ボタン押下で確定する。 押下後、ボタン色反転することを確認する。 NDT mappingの設定 NDT mappingの設定を行う。 Runtime Managerの［Computing］タブを選択。 ndt_map項目［app］押下でパラメタ設定画面を表示する。 ndt_mappingパラメタ項目を適宜設定する。（※入力内容を反映するため、設定項目ごとにenterキーを入力すること。） ［Close］ボタン押下で前画面に戻る。 ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P117参照 # 項目名 内容 単位 smagv妥当値 1 Resolution 地図データをNDTのボクセルに変換する際のボクセル１辺の長さを指定。市街地では１m程度が妥当。 m 1 2 Step Size マッチングの計算で、ノード内部では直線探索法によって繰り返し計算を行っている。その際のステップ幅を表す。 0.1 3 Transformation Epsilon スキャンマッチングの繰り返し計算の収束条件を設定。 0.01 4 Maximum Iteration 繰り返し計算における、最大の繰り返し数を表す。収束条件を満たさない場合は、この数値の回数だけ繰り返し計算を行ったら自動的に計算を打ち切る。 回 30 5 Leaf Size スキャンデータのダウンサンプリングサイズ。 m 1 6 Minimum Scan Range 特定の距離よりも近いスキャンポイントを無視する。（取り付けた車体をLiderが検知しないようにするため。） m 0.5 7 Maximum Scan Range 特定の距離よりも遠いスキャンポイントを無視する。 ｍ 100 8 Minimum Add Scan Shift Lider点群を地図として追加する頻度（移動距離）。0の場合はすべてのSCANデータ。 m 0.5 ndt_map項目チェックBOXをチェックありにする。 ［RViz］ボタン押下でRVizを起動する。 RVizの設定 RViz起動後、defaultのRViz設定ファイルを開く。（~/Autoware/ros/src/.config/rviz/default.rviz） その後、以下topic表示を追加する。 ［add］押下で追加トピック選択画面を表示する。 追加トピック選択画面の［by topic］タブを選択。 ［/ndt_map］トピックの［PointsCloud2］を選択する。 ［OK］ボタン押下で確定する。 ROSBAG一時停止からの再生 一時停止中のROSBAGを再生する。 Runtime Managerウィンドウから、［Simulation］タブを選択。 ［Pause］ボタン押下でROSBAGファイル再生を開始する。 NDTMAP作成の確認 RVizウィンドウに切り替え、点群地図が作成されていくことを確認する。 点群地図の保存 ROSBAG再生終了後、作成した点群地図を保存する。 NDT mappingの設定を行う。 Runtime Managerの［Computing］タブを選択。 ndt_map項目［app］押下でパラメタ設定画面を表示する。 ［Ref］ボタン押下で点群地図ファイル（.pcd）を選択する。 フィルター（地図データをNDTのボクセルに変換する際のボクセル１辺の長さ）を指定する。（狭いエリアであれば「Original」選択でもよい。） ［PCD OUTPUT］ボタン押下でファイルを書き出す。 他のターミナルウィンドウに「Saved xxxxxx data points to xxxxxx.pcd.」を表示すれば保存完了。 その他 作成した地図は、作成を開始した箇所が原点となっている。 作成した地図を自己位置推定に使用する場合、［Map］タブ［TF］項目を設定する必要がある。 "},"src/md/chpt0700.html":{"url":"src/md/chpt0700.html","title":"AGVの自己位置推定","keywords":"","body":"AGVの自己位置推定 Autowareによる自己位置推定方法（点群地図とのマッチング）を以下に示す。 事前に、以下のいずれかを準備しておくこと。 velodyne、SMAGVの起動 ROSBAG再生の一時停止 Baselink to Localizerの設定（任意） base_linkから見た、lider（points_raw）のTFを設定する。 点群地図作成時に、「Baselink to Localizer」を設定している場合、本設定は必須ではない。（たぶん） 点群地図作成時に、設定していない場合マッチングが正常動作しないことある。その際は本項目を設定することでマッチングが正常動作することがある。 詳細については、前章参照。 Vihicle Modelの設定（任意） RVizに表示するVihicle Modelを設定する。（表示が必要な場合のみ） 詳細については、前章参照。 Map関連情報の設定 マッチングに使う点群地図とTFの設定 Runtime Managerの［Map］タブを選択。 Point Cloudグループ［Ref］ボタン押下で点群地図ファイルを選択する。 Point Cloudグループ［Point Cloud］ボタン押下で確定する。 押下後、ボタン色反転することを確認する。 TFグループ［Ref］ボタン押下でTFファイルを選択する。 TFグループ［TF］ボタン押下で確定する。 押下後、ボタン色反転することを確認する。 ※点群地図は、作成を開始した箇所が原点となっている。点群地図を自己位置推定に使用する場合、［Map］タブ［TF］項目を設定する必要がある。 ボクセルグリッドフィルタの設定 点群の密度を下げて、位置合わせ処理が膨大になることを防ぐための、ボクセルグリッドフィルタリングを行う。 Runtime Managerの［Sensing］タブを選択。 voxel_grid_filter項目［app］押下でパラメタ設定画面を表示する。 voxel_grid_filterパラメタ項目を適宜設定する。（※入力内容を反映するため、設定項目ごとにenterキーを入力すること。） ［OK］ボタン押下で前画面に戻る。 # 項目名 内容 単位 smagv妥当値 1 Points Topic フィルタリング対象のトピック名。 - /points_raw 2 Voxel Leaf Size スキャンデータのダウンサンプリングサイズ。 m 0.3 3 Measuremest Range 測定範囲。 ｍ 200 voxel_grid_filter項目チェックBOXをチェックありにする。 NDTマッチングの設定 Runtime Managerの［Computing］タブを選択。 ndt_matching項目［app］押下でパラメタ設定画面を表示する。 voxel_grid_filterパラメタ項目を適宜設定する。（※入力内容を反映するため、設定項目ごとにenterキーを入力すること。） ［OK］ボタン押下で前画面に戻る。 ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P112参照 # 項目名 内容 単位 smagv妥当値 1 Error Threshold エラーしきい値。 1 2 Resolution 地図データをNDTのボクセルに変換する際のボクセル１辺の長さを指定。市街地では１m程度が妥当。 m 0.5 3 Step Size マッチングの計算で、ノード内部では直線探索法によって繰り返し計算を行っている。その際のステップ幅を表す。 0.05 4 Transformation Epsilon スキャンマッチングの繰り返し計算の収束条件を設定。 0.01 5 Maximum Iteration 繰り返し計算における、最大の繰り返し数を表す。収束条件を満たさない場合は、この数値の回数だけ繰り返し計算を行ったら自動的に計算を打ち切る。 回 30 ※smagvにはGPS未搭載のため、「Initial Pos」でよい。 ※Use Odometryありの場合ずれることがある。 ndt_matching項目チェックBOXをチェックありにする。 ［RViz］ボタン押下でRVizを起動する。 RVizの設定 RViz起動後、defaultのRViz設定ファイルを開く。（~/Autoware/ros/src/.config/rviz/default.rviz） その他 ROSBAG再生を一時停止している場合は、再生再開をする。 点群地図を表示してない場合、RViz［Points Map］項目のチェックをいったん外し、再度チェックする。 点群地図とのマッチングができていない（ずれた）場合、Runtime Manager［Computing］タブ、ndt_matching項目チェックのチェックをいったん外し、再度チェックありにすることで再度マッチングを行う。 "},"src/md/chpt0800.html":{"url":"src/md/chpt0800.html","title":"経路設定ファイル作成","keywords":"","body":"経路設定ファイル作成 ROSBAGに取得した走行履歴をもとに経路設定（waypoint）ファイルの作成方法を以下に示す。 事前に、以下の準備をしておくこと。 ・AGVの自己位置推定設定（※ROSBAG再生 ~ ROSBAG一時停止の再開直前まで） AGVの推定姿勢・速度算出の設定 AGVの推定姿勢・速度算出のため、｢vel_pose_connect｣を設定する。 Runtime Managerの［Computing］タブを選択。 vel_pose_connect項目［app］押下でパラメタ設定画面を表示する。 vel_pose_connectパラメタ項目を適宜設定する。（※設定内容はたぶん画面内容のままでよい。） ［OK］ボタン押下で前画面に戻る。 ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P158参照 vel_pose_connect項目チェックBOXをチェックありにする。 waypoint saverの設定 AGVの姿勢・速度をもとに、waypointファイルを作成するための設定をする。 Runtime Managerの［Computing］タブを選択。 waypoint_saver項目［app］押下でパラメタ設定画面を表示する。 waypoint_saverパラメタ項目を適宜設定する。 ［OK］ボタン押下で前画面に戻る。 # 項目名 内容 単位 smagv妥当値 1 Save File 出力するwaypointファイル名。（新規ファイル名を設定すること。） - - 2 Input Type － Vehicle･･･ 3 Save/curre･･･ チェックありにし、ポイント取得間隔を設定する。 ｍ 0.5 waypoint_saver項目チェックBOXをチェックありにする。 ROSBAG再生の再開 一時停止しているROSBAG再生を再開をする。 RViz表示で、走行経路上にwaypointが、表示されていくことを確認する。 その他 動作完了後、指定したCSVファイルが作成されていることを確認する。 "},"src/md/chpt0900.html":{"url":"src/md/chpt0900.html","title":"経路の自動走行","keywords":"","body":"経路の自動走行 作成した経路設定（waypoint）ファイルに従い自動走行を行う方法を以下に示す。 事前準備 事前に以下の準備をしておくこと。 準備1 Autoware関連launchファイルの変更 障害物として検知しない距離の設定を行う。（無視する半径） AGV本体（車体）を障害物として検知しないよう設定する。 項目 内容 備考 ファイル名 velocity_set.launch 格納先 ~/Autoware/ros/install/waypoint_planner/share/waypoint_planner/launch 1.11.1 ~/Autoware/ros/src/computing/planning/motion/packages/astar_planner/launch 1.10.0 変更内容 ↑ここの値を変更する（0.4~0.5が妥当）(default:2.3) 上記 6行目の「remove_points_upto」の値を変更する。（点群データを無視する範囲（センサからの距離）、半径。） 設定した内容は、Runtime Manager［Computing］タブ－［velocity_set］項目のチェックBOXを「チェックあり」にした時に反映する。反映がうまくいかない場合は、Autowareの再起動を行う。 準備2 その他、以下の準備をしておくこと。 velodyne、SMAGVの起動。 AGVの自己位置推定設定。 AGVの推定姿勢・速度算出の設定 AGVの推定姿勢・速度算出のため、｢vel_pose_connect｣を設定し、チェックありにする。 詳細は前章参照のこと。 waypoint_loaderの設定 waypointファイルの読み込み設定をする。 Runtime Managerの［Computing］タブを選択。 waypoint_loader項目［app］押下でパラメタ設定画面を表示する。 waypoint_loaderパラメタ項目を適宜設定する。 ［OK］ボタン押下で前画面に戻る。 # 項目名 内容 単位 備考 1 調整中 － waypoint_loader項目チェックBOXをチェックありにする。 waypoint_planner（astar_planner）項目の設定 以下、waypoint_planner項目を設定する。（Autowareバージョンによっては、「astar_planner」となっている場合があるので読み替えのこと。） aster_avoid（obstacle_avoid）の設定 経路上の障害物に対して回避経路を生成するための設定をする。 以下、aster_avoid項目を設定する。（Autowareバージョンによっては、「obstacle_avoid」となっている場合があるので読み替えのこと。） Runtime Managerの［Computing］タブを選択。 aster_avoid項目［app］押下でパラメタ設定画面を表示する。 aster_avoidパラメタ項目を適宜設定する。 ［OK］ボタン押下で前画面に戻る。 # 項目名 内容 単位 備考 1 調整中 － aster_avoid項目チェックBOXをチェックありにする。 velocity_setの設定 経路上の物体を検出し、最終的な速度を決定するための設定をする。 以下、velocity_set項目を設定する。 velocity_set項目［app］押下でパラメタ設定画面を表示する。 velocity_setパラメタ項目を適宜設定する。 ［OK］ボタン押下で前画面に戻る。 ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P163参照 # 項目名 内容 単位 SMAGV妥当値 備考 1 Use Crosswalk Detection 横断歩道上の物体を検出するかどうかを選択する。 - - 2 Enable Multiple Crosswalk Detection 複数の横断歩道を検出対象とするかどうかを選択する。 - - 3 Points Topic 物体検出に利用する点群トピック名を指定する。 - points_raw 4 Enable Planner dynamical switch waypointを動的に書き換えるかどうかを指定する。 - - 1.10.0 5 Stop Distance for Obstacle 経路上の物体を検知した際の前方障害物までの停止距離を指定する。 m 2 1未満危険 6 Stop Distance for Stopline 経路上の停止線までの停止距離を指定する。 m 5 7 Detection Range 経路上の物体を検出して停止する際の検出範囲を指定する。 m 0.4 8 Deceleration Range 経路上の物体を検出して減速する際の検出範囲を指定する。 m ０ 9 Points Threshold 経路上の物体を検出する際の点の数のしきい値を指定する。この値以上の点が検出範囲内にあれば物体を検出する。 個 5 10 Detection Height Top 検出する点群の高さの上限を指定する。高さは点群の検出に用いているセンサからの距離。 m 0.3 11 Detection Height Bottom 検出する点群の高さの下限を指定する。 m -0.9 12 Deceleration for Obstacle 物体を検出して停止・減速する際の減速度を指定する。 m/s^2 0.7 13 Deceleration for Stopline 停止線を検出して停止・減速する際の減速度を指定する。 m/s^2 0.3 14 Velocity Change Limit 現在速度と目標速度の差がこの値より大きくならないようにする。急ブレーキを回避するためのパラメタ。 km/h 7 15 Tempral Waypoint Size 次のノードに渡すためにPublishするwaypointの数を指定する。 個 100 velocity_set項目チェックBOXをチェックありにする。 waypoint_follower項目の設定 以下、waypoint_follower項目を設定する。（Autowareバージョンによっては、項目の位置が異なる場合がある。） pure_pursuitの設定 自己位置から目標位置までの曲率（滑らかなカーブにする）を求めるためのアルゴリズムの設定をする。 以下、pure_pursuit項目を設定する。 Runtime Managerの［Computing］タブを選択 pure_pursuit項目［app］押下でパラメタ設定画面を表示する pure_pursuitパラメタ項目を適宜設定する ［OK］ボタン押下で前画面に戻る ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P177,179,180参照 # 項目名 内容 waypoint Dialog 単位 smagv妥当値 1 Waypoint 目標速度をwaypointファイルに定義されている速度から取得する。（通常はこちらを使用する） 〇 - 2 Dialog Velocityパラメタから取得する。（こちらを選択すると、障害物を検知しても、停止しない） 〇 - 3 Velocity 目標速度（固定値）。ターゲットボールの移動速度。 〇 km/h － 4 Lookahead Distance 目標点までの距離（固定値）。ターゲットボールまでの距離。 〇 m 1.0~2.0 5 lookahead_ratio 目標点を決めるパラメタ。その速度で何秒先に到達する位置を目標点とするかを表す。 〇 秒 2.0~2.5 6 minimumlookahead distance 目標点までの距離の最低値。 〇 m 0.5~1.0 pure_pursuit項目チェックBOXをチェックありにする。 twist_filterの設定 自己位置から目標位置までの曲率を求めるためのアルゴリズムの設定をする。 以下、twist_filter項目を設定する。 Runtime Managerの［Computing］タブを選択。 twist_filter項目［app］押下でパラメタ設定画面を表示する。 twist_filterパラメタ項目を適宜設定する。 ［OK］ボタン押下で前画面に戻る。 ※設定詳細は、「Autoware 自動運転ソフトウェア入門」P177参照 # 項目名 内容 単位 smagv妥当値 1 lateral_accel_limit 横加速度（m/s^2）の許容範囲。 m/s^2 2 lowpass_gain_linear_x 目標並進速度に対するローパスフィルタのゲイン。縦速度の許容範囲を表す。 3 lowpass_gain_angular_z 目標角速度に対するローパスフィルタのゲイン。横回転速度の許容範囲を表す。 twist_filter項目チェックBOXをチェックありにする。 lane_planner項目の設定 以下、lane_planner項目を設定する。 lane_rule項目チェックBOXをチェックありにする。 lane_stop項目チェックBOXをチェックありにする。 lane_select項目チェックBOXをチェックありにする。 トピックの確認 Runtime Managerの［Topics］タブを選択し、［/vehicle_cmd］トピックがPublishされていることを確認する。 （echoありで、linear、angularのデータが変化していることを確認する） SMAGVの自動運転切り替え Bluetoothゲームパッドの［Y］ボタン押下で自動走行モードに切り替え、AGVが自動走行することを確認する。 Bluetoothゲームパッドによるの走行モード切替えボタン ボタン 走行モード 内容 有効トピック Ｘ 手動走行（ゲームパッド） Bluetoothゲームパッドの左スティックによる手動制御へ切替える。 /smagv/vehicle_cmd Ｙ 自動走行 Autowareからのトピックによる命令、またはrosからのトピックによる命令へ切替える。 /vehicle_cmd 、 /cmd_vel Ｂ 手動走行（JWスティック） アカデミックパック本体設置のジョイスティックによる制御へ切替える。 － Ａ＋左スティック押込み 緊急停止 アカデミック電源Off。押込みをやめると電源を復帰する。電源復帰後は、手動走行（ゲームパッド）モードになる。 － その他 特になし "}}